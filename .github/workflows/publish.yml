# name of the action
name: publish

# trigger on push events with branch main
on:
  push:
    branches: [ main ]

# pipeline to execute
jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
    - name: clone
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      with:
        # ensures we fetch tag history for the repository
        fetch-depth: 0

    - name: install go
      uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # v5.5.0
      with:
        # use version from go.mod file
        go-version-file: 'go.mod'
        cache: true
        check-latest: true

    - name: setup
      run: |
        # define the kaniko version to use
        # renovate: datasource=github-releases depName=chainguard-dev/kaniko
        echo "KANIKO_VERSION=v1.24.0" >> $GITHUB_ENV

    - name: check if kaniko base image exists
      id: check-kaniko
      run: |
        KANIKO_IMAGE="target/kaniko/executor:debug-${KANIKO_VERSION}"
        echo "Checking for image: ${KANIKO_IMAGE}"
        
        if docker manifest inspect ${KANIKO_IMAGE} > /dev/null 2>&1; then
          echo "Image ${KANIKO_IMAGE} already exists"
          echo "exists=true" >> $GITHUB_OUTPUT
        else
          echo "Image ${KANIKO_IMAGE} does not exist, will build"
          echo "exists=false" >> $GITHUB_OUTPUT
        fi
        
        echo "kaniko_image=${KANIKO_IMAGE}" >> $GITHUB_OUTPUT

    - name: checkout kaniko repository
      if: steps.check-kaniko.outputs.exists == 'false'
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      with:
        repository: chainguard-dev/kaniko
        ref: ${{ env.KANIKO_VERSION }}
        path: kaniko-repo

    - name: login to docker hub for kaniko build
      if: steps.check-kaniko.outputs.exists == 'false'
      uses: docker/login-action@9780b0c442fbb1117ed29e0efdff1e18412f7567 # v3.3.0
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: build and push kaniko images
      if: steps.check-kaniko.outputs.exists == 'false'
      working-directory: kaniko-repo
      run: |
        REGISTRY=target/kaniko make images
        
        docker tag target/kaniko/executor:debug target/kaniko/executor:debug-${KANIKO_VERSION}
        docker push target/kaniko/executor:debug-${KANIKO_VERSION}

    - name: return to vela-kaniko checkout
      if: steps.check-kaniko.outputs.exists == 'false'
      run: |
        rm -rf kaniko-repo

    - name: build vela-kaniko binary
      env:
        GOOS: linux
        CGO_ENABLED: '0'
      run: |
        make build-static-ci

    - name: publish vela-kaniko
      uses: elgohr/Publish-Docker-Github-Action@4feac4d53e4e55dcc5d3e2ad0ed2e0a76028ff7a # v5
      with:
        name: target/vela-kaniko
        cache: true
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        buildargs: KANIKO_IMAGE=${{ steps.check-kaniko.outputs.kaniko_image }}
